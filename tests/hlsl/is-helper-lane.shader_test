[require]
shader model >= 6.0

[uav 0]
format r32 uint
size (buffer, 1)
0

% The compiled DXIL uses a scalar global variable with initialiser,
% and truncation of a uint to bool. IsHelperLane() is a proxy for
% SV_Coverage == 0, but the stored value is updated if discard occurs.

[pixel shader]
RWBuffer<uint> u0;
uint enable_discard;

float4 main(float4 pos : SV_Position) : SV_Target
{
    if (enable_discard && frac((floor(pos.x) + floor(pos.y)) / 2) == 0.5)
        discard;
    uint u = IsHelperLane();
    InterlockedOr(u0[0], QuadReadAcrossX(u));
    return float4(ddx(pos.x), ddx(pos.y), 0, 1);
}

[test]
uniform 0 uint 0
draw quad
probe all rgba (1.0, 0.0, 0.0, 1.0)
probe uav 0 (0) rui (0)

uniform 0 uint 1
clear rtv 0 0 0 0 0
draw quad
probe rtv 0 (0, 0) rgba (1.0, 0.0, 0.0, 1.0)
probe rtv 0 (1, 0) rgba (0.0, 0.0, 0.0, 0.0)
probe uav 0 (0) rui (1)
